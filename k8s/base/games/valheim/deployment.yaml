apiVersion: apps/v1
kind: Deployment
metadata:
  name: valheim-server
  labels:
    app: valheim-server
    craftcloud.role: game_server
spec:
  replicas: 1
  selector:
    matchLabels:
      app: valheim-server
  template:
    metadata:
      labels:
        app: valheim-server
        craftcloud.role: game_server
    spec:
      containers:
        # 1. The Main Game Server
        - name: valheim
          image: lloesche/valheim-server:latest
          ports:
            - containerPort: 2456
              protocol: UDP
            - containerPort: 2457
              protocol: UDP
          env:
            - name: SERVER_NAME
              value: "CraftCloud K8s"
            - name: SERVER_PUBLIC
              value: "1"
          volumeMounts:
            - name: world-data
              mountPath: /config
            # --- NEW: Mounting the second volume into the container ---
            - name: game-binaries
              mountPath: /opt/valheim
              
        # 2. The Sidecar Monitor (running in the same Pod!)
        - name: sidecar
          image: valheim-sidecar-image 
          env:
            - name: TARGET_CONTAINER_NAME
              value: "localhost" 
            - name: MANAGER_API_URL
              value: "http://manager-api:5000"
            - name: LOG_FILE_PATH
              value: "/config/Bepinex/LogOutput.log"
          volumeMounts:
            - name: world-data
              mountPath: /config
              readOnly: true
              
      volumes:
        - name: world-data
          persistentVolumeClaim:
            claimName: valheim-world-pvc
        # --- NEW: Telling the Pod where the 'game-binaries' storage comes from ---
        - name: game-binaries
          persistentVolumeClaim:
            claimName: valheim-binaries-pvc